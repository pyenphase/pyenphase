# Current Transformer Data

This section documents CT data for Envoyâ€‘metered systems via {py:class}`~pyenphase.models.meters.EnvoyMeterData`.

Depending on how many and which CT are installed, data is available in:

- {py:attr}`pyenphase.EnvoyData.ctmeter_production`
- {py:attr}`pyenphase.EnvoyData.ctmeter_consumption`
- {py:attr}`pyenphase.EnvoyData.ctmeter_storage`

There are multiple CT types that can be installed. The CT meter types are enumerated as `production`, `storage`, `net-consumption`, and `total-consumption` by `pyenphase.models.meters.CtType`. One or more of these can be installed and enabled. For multi-phase configurations, there will be one per phase.

The consumption CT can be either `net-consumption` (installed at the grid boundary) or `total-consumption` (measuring house load); see [ct-model](#ct-model) below. The IQ Metered collar has a `net-consumption` CT embedded.

```python
    data: EnvoyData = await envoy.update()

    production_ct = data.ctmeter_production

    print(f'eid: {production_ct.eid}')
    print(f'timestamp: {production_ct.timestamp}')
    print(f'energy_delivered: {production_ct.energy_delivered}')
    print(f'energy_received: {production_ct.energy_received}')
    print(f'power_factor: {production_ct.power_factor}')
    print(f'active_power: {production_ct.active_power}')
    print(f'voltage: {production_ct.voltage}')
    print(f'current: {production_ct.current}')
    print(f'frequency: {production_ct.frequency}')
    print(f'state: {production_ct.state}')
    print(f'measurement_type: {production_ct.measurement_type}')
    print(f'metering_status: {production_ct.metering_status}')
    print(f'status_flags: {production_ct.status_flags}')

```

To detect how many CT are installed use Envoy property {py:attr}`~pyenphase.Envoy.ct_meter_count`. One can identify which CT meters are available by testing the {py:attr}`~pyenphase.Envoy.production_meter_type`, {py:attr}`~pyenphase.Envoy.consumption_meter_type`, or {py:attr}`~pyenphase.Envoy.storage_meter_type`.

```python
    how_many_ct = envoy.ct_meter_count

    consumption_ct = 'installed' if envoy.consumption_meter_type else 'not installed'
    production_ct = 'installed' if envoy.production_meter_type else 'not installed'
    storage_ct = 'installed' if envoy.storage_meter_type else 'not installed'

    print(f'This envoy has Production CT {production_ct}, Consumption CT {consumption_ct} and Storage CT {storage_ct}')

```

## Consumption CT options

The consumption CT can be installed in 1 of 2 configurations: either `Solar + Load` or `Load only`. The property {py:attr}`~pyenphase.Envoy.consumption_meter_type` indicates whether the CT is operating in `net-consumption` or `total-consumption` mode.

When in `net-consumption` mode, {py:attr}`~pyenphase.models.meters.EnvoyMeterData.energy_delivered` reports net energy delivered to your site (received from the grid), while {py:attr}`~pyenphase.models.meters.EnvoyMeterData.energy_received` reports net energy received from your site (sent to the grid).[^1][^2] In `total-consumption` mode, it reports only the load (house) consumption.

{py:attr}`~pyenphase.models.meters.EnvoyMeterData.active_power` is the current power flow and will be positive or negative based on actual flow of energy.

[^1]: Provided the CT is installed on the main grid entry.

[^2]: Variations between firmware release may exist.

```python

net_consumption = data.ctmeter_consumption.energy_delivered # Grid import
net_production = data.ctmeter_consumption.energy_received   # Grid export
net_power = data.ctmeter_consumption.active_power

```

## Production CT Options

The production CT measures solar production. {py:attr}`~pyenphase.models.meters.EnvoyMeterData.energy_delivered` reports the energy generated by the solar array, while {py:attr}`~pyenphase.models.meters.EnvoyMeterData.energy_received` reports energy consumed by the solar hardware. The latter is typically minimal (e.g., inverter consumption during dawn and dusk).[^2]

## Storage CT Options

The storage CT measures battery charge and discharge. {py:attr}`~pyenphase.models.meters.EnvoyMeterData.energy_delivered` reports energy discharged from the battery, while {py:attr}`~pyenphase.models.meters.EnvoyMeterData.energy_received` reports energy charged to the battery.[^2]

An Envoy metered with CTs installed sources production and consumption data from the CT meters. The [system_production](data_production.md#system_production-data) data is sourced from the production CT. The [system_consumption](data_consumption.md#system_consumption-data) data represents total house load and is either sourced from the consumption CT in `total-consumption` mode or calculated by the Envoy from both production and consumption CTs when the consumption CT is in `net-consumption` mode.

Net-consumption is reported by the [`/production.json?details=1`](endpoint_json.md#productionjsondetails1) endpoint as an increasing/decreasing total of import and export. The CT readings however, provide these as 2 increasing properties. Production is reported in [system_production](data_production.md#system_production-data) as a single value as well.

## Multi phase CT

For [metered Envoy with multi-phase installations](./phase_data.md#phase-data), CT phase data is available in Envoy classes:

- {py:attr}`pyenphase.EnvoyData.ctmeter_production_phases`
- {py:attr}`pyenphase.EnvoyData.ctmeter_consumption_phases`
- {py:attr}`pyenphase.EnvoyData.ctmeter_storage_phases`

keyed by {py:class}`~pyenphase.const.PhaseNames`.

Phase data is only populated if CTs are installed on more than 1 phase for production and/or consumption phases.

To detect if multiple phases are reporting, use the Envoy property {py:attr}`~pyenphase.Envoy.phase_count`.

```python
    data: EnvoyData = await envoy.update()

    if envoy.phase_count > 1:
        for phase, phase_data in data.ctmeter_production_phases.items():
            for key, value in vars(phase_data).items():
                print(f'{phase} {key}: {value}')
```

## CT Model

Below is a generic model for installed CTs. Each CT can be considered as facing the switchboard and reporting energy delivered to the switchboard in its `energy_delivered` property and energy received from the switchboard in `energy_received`. Power is positive towards the switchboard and negative from the switchboard.

![ct-model showing optional CT configuration](ct-model.png)

These properties have different meaning for each specific CT. For a net-consumption CT, delivered is import from the grid, for Solar production CT, it is solar production and for a battery CT it is battery discharge. A total-consumption CT typically has no delivery but only receives what is consumed by the house.

## Data sources

The data is provided by the [updaters](updaters.md) below.

This data set is identified by the {py:class}`pyenphase.const.SupportedFeatures` flag {py:attr}`~pyenphase.const.SupportedFeatures.CTMETERS`. In addition it returns {py:attr}`~pyenphase.const.SupportedFeatures.THREEPHASE` or {py:attr}`~pyenphase.const.SupportedFeatures.DUALPHASE` to signal if a multi-phase mode is active.

### {py:class}`~pyenphase.updaters.meters.EnvoyMetersUpdater`

This is the default updater for CT data. It provides data for aggregated phases and individual phases. Data is measured/calculated by the Envoy.

|                                                                     |                                                                               |     |
| ------------------------------------------------------------------- | ----------------------------------------------------------------------------- | --- |
| endpoint config                                                     | [`/ivp/meters`](endpoint_json.md#ivpmeters)                                   |     |
| endpoint data                                                       | [`/ivp/meters/readings`](endpoint_json.md#ivpmetersreadings)                  |     |
| json path config                                                    | `$`                                                                           |     |
| eid of production                                                   | `[?(@.measurementType=='production' <br>  && @.state=='enabled')][eid]`       |     |
| eid of consumption                                                  | `[?(@.measurementType=='net-consumption'<br>  && @.state=='enabled')][eid]`   |     |
|                                                                     | `[?(@.measurementType=='total-consumption'<br>  && @.state=='enabled')][eid]` |     |
| eid of storage                                                      | `[?(@.measurementType=='storage'<br>  && @.state=='enabled')][eid]`           |     |
| json path aggregated                                                | `[?(@.eid==<eid of ....>)]`                                                   |     |
| json path phases                                                    | `[?(@.eid==<eid of ....>)].channels[*]`                                       |     |
|                                                                     |                                                                               |     |
| class data                                                          | json node                                                                     | uom |
| {py:attr}`~pyenphase.models.meters.EnvoyMeterData.eid`              | eid                                                                           |     |
| {py:attr}`~pyenphase.models.meters.EnvoyMeterData.timestamp`        | timestamp                                                                     |     |
| {py:attr}`~pyenphase.models.meters.EnvoyMeterData.energy_delivered` | actEnergyDlvd                                                                 | Wh  |
| {py:attr}`~pyenphase.models.meters.EnvoyMeterData.energy_received`  | actEnergyRcvd                                                                 | Wh  |
| {py:attr}`~pyenphase.models.meters.EnvoyMeterData.active_power`     | activePower                                                                   | W   |
| {py:attr}`~pyenphase.models.meters.EnvoyMeterData.power_factor`     | pwrFactor                                                                     |     |
| {py:attr}`~pyenphase.models.meters.EnvoyMeterData.voltage`          | voltage                                                                       | V   |
| {py:attr}`~pyenphase.models.meters.EnvoyMeterData.current`          | current                                                                       | A   |
| {py:attr}`~pyenphase.models.meters.EnvoyMeterData.frequency`        | freq                                                                          | Hz  |
| {py:attr}`~pyenphase.models.meters.EnvoyMeterData.state`            | state                                                                         |     |
| {py:attr}`~pyenphase.models.meters.EnvoyMeterData.measurement_type` | measurementType                                                               |     |
| {py:attr}`~pyenphase.models.meters.EnvoyMeterData.metering_status`  | meteringStatus                                                                |     |
| {py:attr}`~pyenphase.models.meters.EnvoyMeterData.status_flags`     | statusFlags                                                                   |     |
